<script type="text/javascript">
  RED.nodes.registerType("AlarmUltimateZone", {
    category: "Alarm Ultimate",
    color: "#E3CEA0",
    defaults: {
      name: { value: "" },
      alarmId: { value: "", required: true },
      zoneTopic: {
        value: "",
        validate: function (v) {
          const next = String(v || "").trim();
          return Boolean(next);
        },
      },
      topic: { value: "" },
      outputInitialState: { value: true },
    },
    inputs: 0,
    outputs: 1,
    icon: "alarm-ultimate-zone.svg",
    label: function () {
      const selfLabel = this.name || "Alarm Zone";
      try {
        const alarm = this.alarmId ? RED.nodes.node(this.alarmId) : null;
        const alarmLabel = alarm ? (alarm.name || alarm.id || "") : "";
        return alarmLabel ? `${alarmLabel} - ${selfLabel}` : selfLabel;
      } catch (_err) {
        return selfLabel;
      }
    },
    paletteLabel: function () {
      return "Alarm Zone";
    },
    oneditprepare: function () {
      const alarmSelect = $("#node-input-alarmId");
      const zoneSelect = $("#node-input-zoneTopic");
      const httpAdminRoot = (RED.settings && RED.settings.httpAdminRoot) || "/";
      const root = httpAdminRoot.endsWith("/") ? httpAdminRoot : `${httpAdminRoot}/`;
      const panelButton = $("#node-input-alarm-panel");

      function apiUrl(path) {
        return `${root}${path.replace(/^\//, "")}`;
      }

      panelButton.off("click").on("click", (evt) => {
        evt.preventDefault();
        const alarmId = alarmSelect.val() || this.alarmId || "";
        const idPart = alarmId ? `?id=${encodeURIComponent(alarmId)}` : "";
        window.open(
          `${root}alarm-ultimate/alarm-panel${idPart}`,
          "_blank",
          "noopener,noreferrer",
        );
      });

      function loadAlarms() {
        return $.getJSON(apiUrl("alarm-ultimate/alarm/nodes"))
          .done((data) => {
            const nodes = Array.isArray(data && data.nodes) ? data.nodes : [];
            alarmSelect.empty();
            alarmSelect.append($("<option></option>").attr("value", "").text("-- select --"));
            nodes.forEach((n) => {
              const label = n.name ? `${n.name} (${n.id})` : n.id;
              alarmSelect.append($("<option></option>").attr("value", n.id).text(label));
            });
            if (this.alarmId) alarmSelect.val(this.alarmId);
          })
          .fail(() => { });
      }

      function loadZones(alarmId) {
        zoneSelect.empty();
        zoneSelect.append($("<option></option>").attr("value", "").text("-- select alarm first --"));
        if (!alarmId) return;
        $.getJSON(apiUrl(`alarm-ultimate/alarm/${encodeURIComponent(alarmId)}/state`))
          .done((data) => {
            const zones = Array.isArray(data && data.zones) ? data.zones : [];
            zoneSelect.empty();
            zoneSelect.append($("<option></option>").attr("value", "").text("-- select --"));
            zoneSelect.append($("<option></option>").attr("value", "__all__").text("All zones"));
            zones.forEach((z) => {
              const topic = z.topic || "";
              const label = z.name
                ? topic
                  ? `${z.name} (${topic})`
                  : z.name
                : topic;
              zoneSelect.append($("<option></option>").attr("value", topic).text(label));
            });
            if (this.zoneTopic) zoneSelect.val(this.zoneTopic);
            // Force Node-RED editor to re-run validation (async loaded options may leave the field in error state).
            try {
              zoneSelect.trigger("change");
            } catch (_err) { }
          })
          .fail(() => { });
      }

      alarmSelect.on("change", () => loadZones(alarmSelect.val()));

      try {
        loadAlarms.call(this).always(() => loadZones.call(this, this.alarmId));
      } catch (err) { }
    },
  });
</script>

<script type="text/html" data-template-name="AlarmUltimateZone">
  <div class="form-row">
    <label>VIDEO</label>
    <a
      target="_blank"
      rel="noopener noreferrer"
      href="https://www.youtube.com/watch?v=HUPzhVgObBE&list=PL9Yh1bjbLAYrybBZKykfKLDrRAspj9to4"
    ><i class="fa fa-youtube-play" style="color:#cc0000;"></i> See it on YouTube</a>
  </div>

  <div class="form-row">
    <label>WEB PAGE</label>
    <button type="button" class="red-ui-button" id="node-input-alarm-panel">
      <i class="fa fa-keyboard-o"></i> Panel
    </button>
  </div>

  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>

  <div class="form-row">
    <label for="node-input-alarmId"><i class="fa fa-link"></i> Alarm node</label>
    <select id="node-input-alarmId" style="width: 70%"></select>
  </div>

  <div class="form-row">
    <label for="node-input-zoneTopic"><i class="fa fa-bullseye"></i> Zone</label>
    <select id="node-input-zoneTopic" style="width: 70%"></select>
  </div>

  <div class="form-row" id="au-row-topic">
    <label for="node-input-topic"><i class="fa fa-tag"></i> Topic</label>
    <input type="text" id="node-input-topic" placeholder="(default: &lt;controlTopic&gt;/event)" />
  </div>

  <div class="form-row" id="au-row-outputInitialState">
    <label for="node-input-outputInitialState"><i class="fa fa-bolt"></i> Emit on deploy</label>
    <input type="checkbox" id="node-input-outputInitialState" style="width:auto; margin-top:7px;" />
  </div>
</script>

<script type="text/markdown" data-help-name="AlarmUltimateZone">
Alarm Zone is an output-only node that emits zone open/close events from a selected **Alarm System Ultimate** node.

Quick start:

1. Select the Alarm node.
2. Select the Zone (or **All zones**).
3. Connect to a **Debug** (or to your integrations).

Output message (same format as the Alarm node `.../event` output):

- `msg.topic`: configurable (default: `controlTopic + "/event"`)
- `msg.event`: `zone_open` or `zone_close`
- `msg.payload`: `true|false` (zone open boolean)
- `msg.mode`: `armed|disarmed`
- `msg.zone`, `msg.open`, `msg.bypassed`, `msg.reason` are emitted as **root properties**
- `msg.alarmUltimate`: canonical, versioned envelope

Notes:

- The zone list is loaded from the selected Alarm node state (`/alarm-ultimate/alarm/:id/state`).
- No wiring from the Alarm node is required: select the Alarm node and this node subscribes internally.
- Use the **Panel** button to open the Alarm Panel preselected on the chosen Alarm node.
</script>
