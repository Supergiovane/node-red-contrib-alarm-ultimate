<script type="text/javascript">
  RED.nodes.registerType("AlarmUltimateZone", {
    category: "Alarm Ultimate",
    color: "#CFEFF0",
    defaults: {
      name: { value: "" },
      alarmId: { value: "", required: true },
      zoneId: { value: "", required: true },
      topic: { value: "" },
      outputInitialState: { value: true },
    },
    inputs: 0,
    outputs: 1,
    icon: "alarm-ultimate-zone.svg",
    label: function () {
      return this.name || "Alarm Zone";
    },
    paletteLabel: function () {
      return "Alarm Zone";
    },
    oneditprepare: function () {
      const alarmSelect = $("#node-input-alarmId");
      const zoneSelect = $("#node-input-zoneId");
      const httpAdminRoot = (RED.settings && RED.settings.httpAdminRoot) || "/";
      const root = httpAdminRoot.endsWith("/") ? httpAdminRoot : `${httpAdminRoot}/`;
      const panelButton = $("#node-input-alarm-panel");

      function apiUrl(path) {
        return `${root}${path.replace(/^\//, "")}`;
      }

      panelButton.off("click").on("click", (evt) => {
        evt.preventDefault();
        const alarmId = alarmSelect.val() || this.alarmId || "";
        const idPart = alarmId ? `?id=${encodeURIComponent(alarmId)}` : "";
        window.open(
          `${root}alarm-ultimate/alarm-panel${idPart}`,
          "_blank",
          "noopener,noreferrer",
        );
      });

      function loadAlarms() {
        return $.getJSON(apiUrl("alarm-ultimate/alarm/nodes"))
          .done((data) => {
            const nodes = Array.isArray(data && data.nodes) ? data.nodes : [];
            alarmSelect.empty();
            alarmSelect.append($("<option></option>").attr("value", "").text("-- select --"));
            nodes.forEach((n) => {
              const label = n.name ? `${n.name} (${n.id})` : n.id;
              alarmSelect.append($("<option></option>").attr("value", n.id).text(label));
            });
            if (this.alarmId) alarmSelect.val(this.alarmId);
          })
          .fail(() => {});
      }

      function loadZones(alarmId) {
        zoneSelect.empty();
        zoneSelect.append($("<option></option>").attr("value", "").text("-- select alarm first --"));
        if (!alarmId) return;
        $.getJSON(apiUrl(`alarm-ultimate/alarm/${encodeURIComponent(alarmId)}/state`))
          .done((data) => {
            const zones = Array.isArray(data && data.zones) ? data.zones : [];
            zoneSelect.empty();
            zoneSelect.append($("<option></option>").attr("value", "").text("-- select --"));
            zones.forEach((z) => {
              const topic = z.topic || z.topicPattern || "";
              const label = z.name
                ? topic
                  ? `${z.name} (${topic})`
                  : z.name
                : topic || z.id;
              zoneSelect.append($("<option></option>").attr("value", z.id).text(label));
            });
            if (this.zoneId) zoneSelect.val(this.zoneId);
          })
          .fail(() => {});
      }

      alarmSelect.on("change", () => loadZones(alarmSelect.val()));

      try {
        loadAlarms.call(this).always(() => loadZones.call(this, this.alarmId));
      } catch (err) {}
    },
  });
</script>

<script type="text/html" data-template-name="AlarmUltimateZone">
  <div class="form-row">
    <label>WEB PAGE</label>
    <button type="button" class="red-ui-button" id="node-input-alarm-panel">
      <i class="fa fa-keyboard-o"></i> Panel
    </button>
  </div>

  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>

  <div class="form-row">
    <label for="node-input-alarmId"><i class="fa fa-link"></i> Alarm node</label>
    <select id="node-input-alarmId" style="width: 70%"></select>
  </div>

  <div class="form-row">
    <label for="node-input-zoneId"><i class="fa fa-bullseye"></i> Zone</label>
    <select id="node-input-zoneId" style="width: 70%"></select>
  </div>

  <div class="form-row">
    <label for="node-input-topic"><i class="fa fa-tag"></i> Topic</label>
    <input type="text" id="node-input-topic" placeholder="(default: &lt;controlTopic&gt;/zone/&lt;zoneId&gt;)" />
  </div>

  <div class="form-row">
    <label for="node-input-outputInitialState"><i class="fa fa-bolt"></i> Emit on deploy</label>
    <input type="checkbox" id="node-input-outputInitialState" style="width:auto; margin-top:7px;" />
  </div>
</script>

<script type="text/markdown" data-help-name="AlarmUltimateZone">
Emits the state of a single configured zone from a selected **Alarm System Ultimate** node.

- `msg.payload`: `true` when the zone is open/active, otherwise `false`
- `msg.zone`: `{ id, name?, type? }`
- `msg.bypassed`: `true|false`

Notes:

- The zone list is loaded from the selected Alarm node state (`/alarm-ultimate/alarm/:id/state`).
- Use the **Panel** button to open the Alarm Panel preselected on the chosen Alarm node.
</script>
